---
title: 'Mineria de dades: PAC1'
author: "Autor: Carlos Solís García"
date: "Març 2022"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 05.584-PAC-header.html
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

*****
# Introducció
*****
## Presentació
Aquesta prova d'avaluació continuada cobreix els mòduls "El procés de mineria de dades" i "Preprocessat de les dades i gestió de característiques" del programa de l'assignatura.

## Objectius
* Assimilar correctament els mòduls citats.
* Què és i què no és MD.
* Cicle de vida dels projectes de MD.
* Diferents tipologies de MD.
* Conèixer les tècniques pròpies d'una fase de coneixement, preparació de dades i objectius a assolir.

## Descripció de la PAC a realitzar
La prova està estructurada en 1 exercici teòric/pràctic i 1 exercici pràctic que demana que es desenvolupi la fase de coneixement i preparació amb un joc de dades.
S'han de respondre tots els exercicis per a poder superar la PAC.
La PAC està pensada per resoldre-la en l'entorn Markdown amb RStudio amb R com a llenguatge preferit. És recomana fer-ho així. Si teniu les competències per fer-ho en Python no hi ha cap problema. Podeu fer-ho. Simplement substituïu els chunks de R per chunks en Python. 

## Recursos
Per a realitzar aquesta pràctica recomanem com a punt de partida la lectura dels següents documents:

* Els mòduls "El procés de mineria de dades" i "Preprocessat de les dades i gestió de característiques" del programa de l'assignatura.
* Cicle de vida d'un projecte de mineria de dades: https://es.wikipedia.org/wiki/Cross_Industry_Standard_Process_for_Data_Mining#Fases_principales
* A l'apartat de l'enunciat de l'activitat disposeu d'uns materials de ggplot2.
* L'aula laboratori de R per resoldre dubtes o problemes.
* RStudio Cheat Sheet: Disponible a l'aula Laboratori de Mineria de dades.
* R Base Cheat Sheet: Disponible a l'aula Laboratori de Mineria de dades.


## Format i data de lliurament
El format de lliurament és: **usernameestudiant-PAC1.html (pdf o word) i rmd**. 
S'ha de lliurar la PAC en la bústia de lliuraments de l'aula.


## Nota: Propietat intel·lectual

Sovint és inevitable, en produir una obra multimèdia, fer ús de recursos creats per terceres persones. És per tant comprensible fer-ho en el marc d'una pràctica dels estudis d'Informàtica, Multimèdia i Telecomunicació de la UOC, sempre que això es documenti clarament i no suposi plagi en la pràctica.

Per tant, en presentar una pràctica que faci ús de recursos aliens, s'ha de presentar juntament amb ella un document en què es detallin tots ells, especificant el nom de cada recurs, el seu autor, el lloc on es va obtenir i el seu estatus legal: si l'obra està protegida pel copyright o s'acull a alguna altra llicència d'ús (Creative Commons, llicència GNU, GPL ...).
L'estudiant haurà d'assegurar-se que la llicència no impedeix específicament el seu ús en el marc de la pràctica. En cas de no trobar la informació corresponent haurà d'assumir que l'obra està protegida per copyright.

Haureu, a més, adjuntar els fitxers originals quan les obres utilitzades siguin digitals, i el seu codi font si correspon.

*****
# Exercicis
*****

## Exercici 1:

Proposa un projecte complet de mineria de dades. L'organització de la resposta ha de coincidir en les fases típiques del cicle de vida d'un projecte de mineria de dades. **No cal fer les tasques de la fase**. Per a cada fase indica quin és el objectiu de la fase i el producte que s'obtindrà. Utilitza exemples de quines i com podrien ser les tasques. Si hi ha alguna característica que fa diferent el cicle de vida d'un projecte de mineria respecte a d'altres projectes indica-ho.  

> Resposta  

El primer pas per definir el projecte de mineria de dades q ue es durà a terme, és la identificació del problema que es vol resoldre, i la cerca de dades per tal d'estudiar com respondre a aquest problema.  

En aquest projecte de mineria de dades, es compta amb dos datasets amb les propietats físico químiques de vins portuguesos, de la varietat "Vinho Verde", així com la seva evaluació de qualitat, basada en la valoració d'experts [Cortez det al., 2009]  
Els datasets han estat recopilats de https://archive.ics.uci.edu/ml/datasets/wine+quality  

La informació està estructurada en dos arxius tipus .csv, un amb les dades referents a l'estudi de vins blancs, i l'altre en referència a l'estudi de vins negres.
Es buscarà detectar quins són els atributs més importants per tal de predir la qualitat del vi, i es compararà si aquest model és diferent per a vins blancs i vins negres.

Aquesta primera fase, d'identificació del problema i cerca del joc de dades, sovint vindria imuplsada per una necessitat de negoci, o bé, de la necessitat d'estudiar possibles formes de modelar un fenòmen. En quant a la cerca de dades, és possible que ja es disposi de dades històriques recollides en els diferents sistemes de l'empresa.   
En aquest exemple d'estudi, una font de dades pot ser l'històric d'analítiques de les propietats fisicoquímiques dels vins, ja que són un requeriment per el control i la qualitat del producte.

A continuació, el següent pas consisteix en preparar les dades, de manera que estiguin en format requerit per a poder fer el modelat.  
Segurament, moltes d'aquestes dades estaran disponibles en fitxers pdf, o taules de fulls de càlcul. Depenent del sector, pot ser que fins i tot hi hagi dades manuals que s'han de digitalitzar. És per això, que en detectar de quines dades es disposa, en primer lloc es recopilin totes.  

El següent que cal fer, és netejar les dades. Cal, en aquesta etapa, controlar que no hi hagi valors nuls, que els formats dels camps estiguin regularitzats, etc.
Per exemple, podriem tenir discrepància entre el caràcter delimitador de decimal, entre punt o coma, segons l'origen de la dada. Això faria que, en un sistema informàtic, algunes es detectessin com a número i altres com a text per al mateix tipus d'informació.  

El següent pas ja seria començar a fer transformacions sobre les dades, també de manera orientada a quina resposta es vol obtenir. Pot ser és interessant discretitzar una variable numèrica en diferents rangs. Per exemple, la valoració dels vins es podría transformar d'una escala de 1 a 10 fins a una escala tipus qualificació d'estrelles. No seria estrany pensar en fer aquesta transformació si volem entendre-ho a nivell d'ecommerce.

En aquesta fase de preparació, també és interessant ser capaç de reduir la dimensionalitat del sistema. Per exemple, en cas d'analítiques fisicoquímiques, sovint és comú trobar diferentes anàlisis amb diferents tècniques, que es poden extrapolar a la quantita d'un element determinat que hi ha a la mostra, o bé a la quantitat de molècules orgàniques. Per tant, és important estudiar bé quines relacions existeixen entre totes les variables disponibles, i com es correlacionen amb l'objectiu que es vol respondre.  

Un cop preparat el joc de dades a analitzar, comença una part altament iterativa, on visualitzem les dades, busquem relacions, i comparem diversos models per tal d'obtenir la millor aproximació del fenòmen que volem buscar. Segons la tècnica a utilitzar, probablement caldrà transformar les dades. Pot ser cal convertir variables qualitatives amb one-hot encoding.

Una vegada trobats els models més rellevants, Caldrà però, donar resposta a la següent pregunta: és prou explicatiu o intuitiu el model com per poder ser aplicat en procés? Una de les dificultats a l'hora de modelar o predir, consisteix a traduir el resultat analític a llenguatge de negoci. Probablement, un model molt precís però molt abstracte alhor, serà difícil d'aplicar en entorns on els usuaris de negoci clarament no són experts.  

Per tant, està clar que l'explicabilitat i representació dels resultats és un punt clau, que també pot fer que haguem de tornar a pasos anteriors. I es que, el cicle de vida d'un projecte de dades no deixa de ser un procés iteratiu.

## Exercici 2:
A partir del joc de dades utilitzat a l'exemple anterior, realitza les tasques prèvies a la generació d’un model de mineria de dades explicades en els mòduls  "El procés de mineria de dades" i "Preprocessat de les dades i gestió de característiques". Pots utilitzar de referència l'exemple anterior però procura canviar l'enfoc i analitzar les dades en funció de les diferent dimensions que presenten les dades.  

> Resposta  

Com s'ha indicat en l'exercici anterior, es compta amb dos datasets amb les propietats físico químiques de vins portuguesos, de la varietat "Vinho Verde", així com la seva evaluació de qualitat, basada en la valoració d'experts [Cortez det al., 2009]  
Els datasets han estat recopilats de https://archive.ics.uci.edu/ml/datasets/wine+quality  

La informació està estructurada en dos arxius tipus .csv, un amb les dades referents a l'estudi de vins blancs, i l'altre en referència a l'estudi de vins negres.
Es buscarà detectar quins són els atributs més importants per tal de predir la qualitat del vi, i es compararà si aquest model és diferent per a vins blancs i vins negres.

### Càrrega del joc de dades
En primer lloc es procedeix a la càrrega del joc de dades. Es llegiran els dos fitxers .csv i es procedirà a unificar els registres dins el mateix dataframe, creant una nova columna que indiqui el tipus de procedència del registre (red, white)

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carrega del joc de dades.
library(plyr)
library(dplyr)
red_wine = read.delim("dataset/winequality-red.csv", sep = ";", dec = ".")
# Creem el nou camp amb el tipus de vi per als negres
red_wine <- red_wine %>% mutate(wine_type = "red")
white_wine = read.delim("dataset/winequality-white.csv", sep = ";", dec = ".")
# Creem el nou camp amb el tipus de vi per als blancs
white_wine <- white_wine %>% mutate(wine_type = "white")
# Combinem els dataframes:
wines <- rbind(red_wine, white_wine)
```
### Exploració del conjunt de dades
Un cop carregat el joc de dades, fem un primer anàlisi de quins camps tenim, de quin tipus són, i una mica de descriptiu bàsic d'aquests.

```{r}
# Mostrem el total de files, columnes, tipus de dades, i alguns exemples.
str(wines)
```
El dataset conté **13** variables (12 atributs originals més l'etiqueta que hem creat per distingir les dades segons el tipus de vi). En total, hi ha **6497** registres.  
Els camps representen les propietats fisicoquímiques a partir de les qual s'avalua la qualitat del vi, de manera sensorial. Vegem què representa cada camp:  
1. **fixed acidity**: g(tartaric acid)/dm^3^    
2. **volatile acidity**: g(acetic acid)/dm^3^   
3. **citric acid**: g/dm^3^   
4. **residual sugar**: g/dm^3^   
5. **chlorides**: g(sodium chloride)/dm^3^    
6. **free sulfur dioxide**: mg/dm^3^   
7. **total sulfur dioxide**: mg/dm^3^   
8. **density**: g/cm^3^   
9. **pH**: Between 0 and 14   
10. **sulphates**: g(potassium sulphate)/dm^3^   
11. **alcohol**: vol.%   
12. **quality**: Sensory score between 0 and 10   
13. **wine_type**: Custom tag to identify wine color  

### Neteja del conjunt de dades
A continuació, estudiem si hi ha valors buits o nuls en el joc de dades
```{r}
# Per a poder buscar-ho, podem fer servir la comanda colsums(), pasant-li com a argunment el resultat de la funció is.na() al dataset, de manera que faci el recompte de tots els valors nuls.
print('Null values (NA) per column')
colSums(is.na(wines))
```
```{r}
# Per mirar si hi ha valors en blanc, és a dir, no registrats amb NA, fem la mateixa estratègia, però buscant posicions buides.
print("Blank values per column")
colSums(wines == "")
```
Amb aquests dos fragments de codi, hem pogut comprovar que en el nostre joc de dades no hi ha valors ni nuls (NA) ni en blanc.  

### Esatdístic preliminar
Seguim explorant el joc de dades. Mostrarem la informació bàsica de cada columna segons el tipus de vi.  
Per als vins negres.
```{r}
print("Red Wines")
wines %>% filter(wine_type == "red") %>% summary()

```
I per als vins blancs:  
```{r}
print("White Wines")
wines %>% filter(wine_type == "white") %>% summary()
```
Si parem atenció als dos sumaris d'informació per a cada tipus de vi, es pot observar que els camps **free sulfur dioxide** i **total sulfur dioxide** poden prendre valors dues o fins i tot 3 ordres de magnitud superiors als de la resta de camps numèrics.  
Això és a causa de que aquests dos camps estan recollits en miligrams. Farem la conversió a grams per tal de normalitzar aquestes dues variables.  
```{r}
# Dividim les dues columnes per 1000 per tal de convertir-les a grams
wines$free.sulfur.dioxide <- wines$free.sulfur.dioxide/1000
wines$total.sulfur.dioxide <- wines$total.sulfur.dioxide/1000

# Mostrem el resultat veient les 5 primeres files del dataset
head(wines, 5)
```
### Visualització del dataset
Arribats a aquest punt, cal recordar que l'objectiu del projecte és ser capaç de predir la qualitat del vi blanc i del vi negre, a partir de diferents paràmetres fisicoquímics mesurats.  
En primer lloc, anem a visualitzar com es distribueix la puntuació de **quality** en les dues poblacions (vi negre i vi blanc).  
```{r}
# Construirem una figura amb els histogrames de qualitat de cada tipus de vi, l'un al costat de l'altre
library(lattice)
library(ggplot2)
library(Rmisc)
qList <- list()
rWineQuality <- wines %>% filter(wine_type == 'red')
whWineQuality <- wines %>% filter(wine_type == 'white')
rwPlot <- ggplot(data = rWineQuality, aes(x = quality)) + geom_histogram(bins = 30, fill = "darkred", color = "black") + ggtitle("Histogram of red wine quality")
qList[[1]] <- rwPlot

whPlot <- ggplot(data = whWineQuality, aes(x = quality)) + geom_histogram(bins = 30, fill = "antiquewhite", color = "black") + ggtitle("Histogram of white wine quality")
qList[[2]] <- whPlot

multiplot(plotlist = qList, cols = 2)
```
  
Com podem veure, en aquest joc de dades, ambues poblacions no estan equilibrades. Existeix una predominància en vins que han estat classificats amb puntuació de qualitat entre 5 i 7 majoritàriament. Aquest serà un fet important quan el nostre model intenti predir qualitats en els extrems inferior o superiors del rang.  

### Extracció de característiques
Tot i que hem partit d'un joc de dades que ja estava bastant preparat per a poder fer tasques d'anàlisi predictiva (el joc de dades no contenia valors buits i hem hagut de fer poques transformacions sobre les dades), sí que cal destacar que, molt probablement, de tots els atributs amb els que comptem, alguns estiguin correlacionats entre ells, i d'altres que tampoc aportin cap grau de relació amb **quality**, que és el valor que volem ser capaços de predir.  

Un clar exemple d'atributs que poden estar correlacionats entre ells són els atributs **free.sulfur.dioxides**, **total.sulfur.dioxides** i **sulphates**, ja que tots tres són formes diferents de representar la quantitat de sofre a la mostra.  

El primer pas per triar quins atributs són significatius per a predir la qualitat, serà representar cada atribut enfront la qualitat per tal de poder buscar si mantenen relació o no.  
Fem-ho visualment per els vins negres.
```{r}
# Creem una llista per mostrar els atributs que volem comparar
wineAttribs <- c("fixed.acidity","volatile.acidity", "citric.acid", "residual.sugar", 
                 "chlorides", "free.sulfur.dioxide", "total.sulfur.dioxide",
                 "density", "pH", "sulphates", "alcohol")
# Filtrem el dataset amb els vins negres.
redWines <- wines %>% filter(wine_type == 'red')
redWineAux <- redWines %>% select(all_of(wineAttribs))
# Creem una llista per mostrar les gràfiques de les correlacions.
redHistList <- vector("list", ncol(redWineAux))
# A continuació construim un loop per elaborar tots els gràfics i incloure'l a la llista que fem servir per al multiplot.
for(i in seq_along(redWineAux)){
  redHistList[[i]] <- local({
    i <- i
    col = redWines[[i]]
    subplot <- ggplot(data = redWineAux, aes(x = redWines$quality, y = col)) +
    geom_point(color = "darkslategrey") + geom_smooth(method = lm, color = "darkorchid1") + theme_bw() + xlab("quality") + ylab(names(redWines)[i])
  })
}
print("Influence of attributes on red wine quality")
multiplot(plotlist = redHistList, cols = 4) 
```
  
Pel que podem observar en aquests gràfics, sembla que les variables amb més relació amb la qualitat (**quality**) del vi negre, són:  
1. **fixed.acidity**  
2. **volatile.acidity**  
3. **citric.acid**  
4. **total.sulfur.dioxide**  
5. **density**  
6. **sulphates**  
7. **alcohol**  

```{r}
# Guardem-los a un vector
redWineAttrs <- c("fixed.acidity","volatile.acidity", "citric.acid",
                   "total.sulfur.dioxide",
                 "density", "sulphates", "alcohol")
```
  
Fem-ho ara per als vins blancs
```{r}
#Aquí aprofitem la mateixa llista d'atributs
whiteWines <- wines %>% filter(wine_type == 'white')
whiteWineAux <- whiteWines %>% select(all_of(wineAttribs))
# Creem una llista per mostrar les gràfiques de les correlacions.
whiteHistList <- vector("list", ncol(whiteWineAux))
# A continuació construim un loop per elaborar tots els gràfics i incloure'l a la llista que fem servir per al multiplot.
for(i in seq_along(whiteWineAux)){
  whiteHistList[[i]] <- local({
    i <- i
    col = whiteWines[[i]]
    subplot <- ggplot(data = whiteWineAux, aes(x = whiteWines$quality, y = col)) +
    geom_point(color = "darkslategrey") + geom_smooth(method = lm, color = "darkorchid1") + theme_bw() + xlab("quality") + ylab(names(redWines)[i])
  })
}
print("Influence of attributes on white wine quality")
multiplot(plotlist = whiteHistList, cols = 4) 
```
  
En el cas dels vins blancs, sembla que els atributs que influeixen en la qualitat són:  
1. **fixed.acidity**  
2. **volatile.acidity**  
3. **residual.sugar**  
4. **chlorides**  
5. **total.sulfur.dioxide**  
6. **density**  
8. **pH**  
9. **sulphates**  
10. **alcohol**  

```{r}
# Guardem-los també a un vector:
whiteWineAttrs <- c("fixed.acidity","volatile.acidity", "residual.sugar", 
                 "chlorides", "total.sulfur.dioxide",
                 "density", "pH", "sulphates", "alcohol")
```
  
Un cop hem detectat quins atributs són susceptibles d'estar relacionats amb la qualitat del vi, fem un pas més, i, mitjançant la correlació entre atributs, eliminarem aquells camps que siguin redundats, ja que si no, estariem aportant informació duplicada al model.  

Estudiem en primer lloc la correlació entre atributs del vi negre:
```{r}
library(corrplot)
# A partir del dataset filtrat per tiups de vi, seleccionem les columnes referents als atributs que hem vist que guarden relació amb la qualitat.
factors <- redWines %>% select(all_of(redWineAttrs))
res <- cor(factors, method="kendall")
corrplot(res, method="color", tl.col="black", tl.srt=30, order="AOE", number.cex=0.75,sig.level=0.01, addCoef.col="black")
```
  
Amb aquest anàlisi, no detectem cap correlació que sigui extremadament positiva o negativa entre dos variables del joc de dades. Sí que hi ha una influència entre els diferents àcids que hi ha al vi, però tot entra dins de la predominància de les espècies en funció del pH de la mostra. És una questió d'equilibri químic en la dissolució. (Això es podria estudiar amb un diagrama logarítmic de distribució d'espècies a la dissolució, a partir de les constants d'equilibri de les diferents formes en funció de l'alcalinitat de la dissolució). En conseqüència, no descartarem cap variable per als vins negres.  

Fem ara el mateix estudi per als vins blancs:  
```{r}
library(corrplot)
# A partir del dataset filtrat per tiups de vi, seleccionem les columnes referents als atributs que hem vist que guarden relació amb la qualitat.
factors <- whiteWines %>% select(all_of(whiteWineAttrs))
res <- cor(factors, method="kendall")
corrplot(res, method="color", tl.col="black", tl.srt=30, order="AOE", number.cex=0.75,sig.level=0.01, addCoef.col="black")
```
  
En aquest cas, també ens trobem en un punt on no hi ha correlacions altament destacables (els coeficients de correlació en cap cas són propers o superiors a 0.9). De la mateixa manera, el comportament entre les variables que representen la quantitat d'una espècie determinada al vi també es pot acabar traduïnt en termes d'equilibri químic en la dissolució. Amb aquests resultats de correlació, tampoc podriem descartar cap variable dels atributs que hem identificat.

### Conclusions
Amb aquest petit estudi hem pogut determinar, a partir del dataset disponible, quins atributs analítics podrien explicar la qualitat sensorial per a vins blancs i vins negres.  

No obstant això, es tracta d'un estudi molt preliminar. L'article de referència d'on s'ha extret el joc de dades tractava els vins negres i blancs com a dos poblacions clarament separades. Un punt de millora d'aquest petit projecte pot ser realitzar el contrast d'hipòtesis per verificar si realment són poblacions diferents, o sí les distribucions són assimilables.  

Un altre aspecte que cal tenir en compte és que en aquest projecte no hem arribat a establir el model de predicció. L'abast finalment ha consistit en l'estudi de quines característiques poden ser determinants, d'entre totes les mesures disponibles.


****
# Criteris d'avaluació.
****

Exercici 1:

Concepte i pes en la nota final.

L'objectiu del projecte està correctament definit amb prou concreció i es pot resoldre amb tècniques de mineria de dades.	15%

Les fases del cicle de vida estan ben expressades. Els exemples son clarificadors. És justifica i argumenta de les decisions que s'han pres. 20%	

Exercici 2:

Es carrega la base de dades, es visualitza la seva estructura i s’explica els fets bàsics de les dades.	5%

S'estudia si existeixen atributs buits o en diferents escales que calgui normalitzar. Si és el cas s'adopten mesures per a tractar aquests atributs. Es construeix un nova variable útil a partir de les existents. Es discretitza algun atribut. 10%

S'analitzen les dades de forma visual i extreuen conclusions tangibles. Cal elaborar un discurs coherent i amb conclusions clares. Cal contextualitzar bé tots els resultats, les conclusions no han de ser tècniques sino "traduïdes" al context que se està treballant.	40%

Es tracta en profunditat algun altre aspecte respecte a les dades presentat en els mòduls "Preprocessat de les dades i gestió de característiques".	10%

